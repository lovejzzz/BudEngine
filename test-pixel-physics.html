<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pixel Physics v3.8 - Acoustic Physics - Bud Engine</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            margin: 0;
            padding: 0;
            background: #0a0a14;
            font-family: 'Courier New', monospace;
            color: #fff;
            overflow: hidden;
            display: flex;
            height: 100vh;
        }
        
        /* World Canvas - Left Side */
        #gameCanvas {
            width: calc(100vw - 320px);
            height: 100vh;
            cursor: crosshair;
            image-rendering: pixelated;
        }
        
        /* Inventory Sidebar - Right Side */
        .sidebar {
            width: 320px;
            height: 100vh;
            background: #0f0f1e;
            border-left: 2px solid #00ffcc;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            overflow-x: hidden;
        }
        
        .sidebar::-webkit-scrollbar {
            width: 8px;
        }
        
        .sidebar::-webkit-scrollbar-track {
            background: #0a0a14;
        }
        
        .sidebar::-webkit-scrollbar-thumb {
            background: #00ffcc;
            border-radius: 4px;
        }
        
        /* Header */
        .header {
            padding: 15px;
            text-align: center;
            border-bottom: 2px solid #00ffcc;
            background: linear-gradient(180deg, #0f0f1e 0%, #1a1a2e 100%);
        }
        
        .header h1 {
            font-size: 18px;
            color: #00ffcc;
            text-shadow: 0 0 10px #00ffcc;
            margin-bottom: 5px;
        }
        
        .header .version {
            font-size: 11px;
            color: #ff8800;
            text-shadow: 0 0 5px #ff8800;
        }
        
        /* Tabs */
        .tabs {
            display: flex;
            flex-wrap: wrap;
            background: #0a0a14;
            border-bottom: 1px solid #333;
            padding: 5px;
            gap: 3px;
        }
        
        .tab {
            flex: 1;
            min-width: 42px;
            padding: 8px 4px;
            background: #1a1a2e;
            border: 1px solid #444;
            color: #888;
            cursor: pointer;
            font-size: 18px;
            text-align: center;
            transition: all 0.2s;
            white-space: nowrap;
        }
        
        .tab:hover {
            border-color: #00ffcc;
            color: #aaa;
        }
        
        .tab.active {
            background: #00ffcc;
            color: #0a0a14;
            border-color: #00ffcc;
            font-weight: bold;
        }
        
        /* Material Grid */
        .material-grid {
            display: none;
            padding: 10px;
            gap: 5px;
            flex-wrap: wrap;
            background: #0f0f1e;
        }
        
        .material-grid.active {
            display: flex;
        }
        
        .material-btn {
            flex: 1 1 calc(50% - 5px);
            min-width: 140px;
            padding: 8px 10px;
            background: #1a1a2e;
            border: 2px solid #444;
            color: #ccc;
            cursor: pointer;
            font-size: 11px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
            position: relative;
        }
        
        .material-btn:hover {
            border-color: #00ffcc;
            box-shadow: 0 0 10px rgba(0, 255, 204, 0.3);
        }
        
        .material-btn.active {
            background: #00ffcc;
            color: #0a0a14;
            border-color: #00ffcc;
            box-shadow: 0 0 20px rgba(0, 255, 204, 0.5);
            font-weight: bold;
        }
        
        .material-swatch {
            width: 14px;
            height: 14px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            flex-shrink: 0;
        }
        
        .material-info {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 2px;
            text-align: left;
        }
        
        .material-name {
            font-weight: bold;
            font-size: 11px;
        }
        
        .material-prop {
            font-size: 9px;
            color: #888;
        }
        
        .material-btn.active .material-prop {
            color: #0a0a14;
            opacity: 0.7;
        }
        
        /* Control Sections */
        .control-section {
            padding: 10px;
            border-bottom: 1px solid #333;
        }
        
        .control-section h3 {
            margin: 0 0 8px 0;
            font-size: 10px;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .control-row {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .control-item {
            display: flex;
            align-items: center;
            gap: 8px;
            background: #1a1a2e;
            border: 1px solid #444;
            padding: 6px 10px;
        }
        
        .control-item label {
            flex: 1;
            font-size: 11px;
            color: #aaa;
        }
        
        .control-item input[type="range"] {
            flex: 2;
            height: 4px;
            -webkit-appearance: none;
            appearance: none;
            background: #333;
            outline: none;
            border-radius: 2px;
        }
        
        .control-item input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 14px;
            height: 14px;
            background: #00ffcc;
            cursor: pointer;
            border-radius: 2px;
        }
        
        .control-item input[type="range"]::-moz-range-thumb {
            width: 14px;
            height: 14px;
            background: #00ffcc;
            cursor: pointer;
            border-radius: 2px;
            border: none;
        }
        
        .control-item .value {
            min-width: 40px;
            text-align: right;
            font-size: 10px;
            color: #00ffcc;
        }
        
        /* Action Buttons */
        .action-btn {
            width: 100%;
            padding: 10px;
            background: #1a1a2e;
            border: 2px solid #444;
            color: #aaa;
            cursor: pointer;
            font-family: 'Courier New', monospace;
            font-size: 11px;
            font-weight: bold;
            transition: all 0.2s;
            text-transform: uppercase;
        }
        
        .action-btn:hover {
            border-color: #00ffcc;
            color: #00ffcc;
            box-shadow: 0 0 15px rgba(0, 255, 204, 0.3);
        }
        
        .action-btn.primary {
            background: #ff4400;
            border-color: #ff6600;
            color: #fff;
        }
        
        .action-btn.primary:hover {
            background: #ff6600;
            border-color: #ff8800;
            box-shadow: 0 0 15px rgba(255, 68, 0, 0.5);
        }
        
        .action-btn.toggle {
            background: #2a2a4e;
            border-color: #5555ff;
            color: #aaaaff;
        }
        
        .action-btn.toggle:hover {
            background: #3a3a6e;
            border-color: #7777ff;
            color: #ccccff;
        }
        
        .action-btn.toggle.active {
            background: #00ffcc;
            border-color: #00ffcc;
            color: #0a0a14;
        }
        
        /* Scenario Buttons */
        .scenario-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 5px;
        }
        
        .scenario-btn {
            padding: 8px;
            background: #2a2a4e;
            border: 2px solid #5555ff;
            color: #aaaaff;
            cursor: pointer;
            font-family: 'Courier New', monospace;
            font-size: 10px;
            transition: all 0.2s;
            text-align: center;
        }
        
        .scenario-btn:hover {
            background: #3a3a6e;
            border-color: #7777ff;
            color: #ccccff;
            box-shadow: 0 0 10px rgba(85, 85, 255, 0.3);
        }
        
        /* Toggle Row */
        .toggle-row {
            display: flex;
            gap: 5px;
        }
        
        .toggle-row .action-btn {
            flex: 1;
            padding: 8px;
            font-size: 10px;
        }
        
        /* Status Bar */
        .status-bar {
            padding: 10px;
            font-size: 10px;
            color: #666;
            text-align: center;
            border-top: 1px solid #333;
            background: #0a0a14;
            margin-top: auto;
        }
        
        .status-bar span {
            color: #00ffcc;
        }
        
        /* Audio Overlay */
        #audioOverlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(10, 10, 20, 0.95);
            z-index: 9999;
            cursor: pointer;
            align-items: center;
            justify-content: center;
            flex-direction: column;
        }
        
        #audioOverlay.active {
            display: flex;
        }
        
        .audio-prompt {
            text-align: center;
            color: #00ffcc;
            font-size: 24px;
            text-shadow: 0 0 20px #00ffcc;
        }
        
        .audio-icon {
            font-size: 48px;
            margin-bottom: 20px;
        }
        
        .audio-subtitle {
            font-size: 14px;
            color: #888;
            margin-top: 10px;
        }
        
        /* Responsive */
        @media (max-width: 1024px) {
            #gameCanvas {
                width: calc(100vw - 280px);
            }
            
            .sidebar {
                width: 280px;
            }
            
            .material-btn {
                min-width: 120px;
            }
        }
        
        @media (max-width: 768px) {
            #gameCanvas {
                width: 100vw;
                height: 70vh;
            }
            
            body {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100vw;
                height: 30vh;
                border-left: none;
                border-top: 2px solid #00ffcc;
            }
        }
    </style>
</head>
<body>
    <!-- World Canvas -->
    <canvas id="gameCanvas"></canvas>
    
    <!-- Inventory Sidebar -->
    <div class="sidebar">
        <!-- Header -->
        <div class="header">
            <h1>‚öõÔ∏è Pixel Physics ‚öõÔ∏è</h1>
            <div class="version">v3.8 ‚Ä¢ ACOUSTIC PHYSICS</div>
        </div>
        
        <!-- Material Tabs -->
        <div class="tabs">
            <div class="tab" data-tab="elements" title="Elements (Water, Ice, Steam)">üåä</div>
            <div class="tab active" data-tab="earth" title="Earth Materials (Sand, Stone, Metals)">ü™®</div>
            <div class="tab" data-tab="energy" title="Energy & Fuels (Fire, Wood, Oil)">üî•</div>
            <div class="tab" data-tab="gases" title="Gases (Oxygen, Hydrogen, Smoke)">üí®</div>
            <div class="tab" data-tab="reactive" title="Reactive Materials (Acid, Salt, Sulfur)">‚öóÔ∏è</div>
            <div class="tab" data-tab="life" title="Living Materials (Plants, Fungus)">üåø</div>
        </div>
        
        <!-- Material Grids -->
        <div class="material-grid" data-grid="elements">
            <button class="material-btn" data-material="ice">
                <div class="material-swatch" style="background: #a0d0ff;"></div>
                <div class="material-info">
                    <div class="material-name">Ice</div>
                    <div class="material-prop">0¬∞C melting</div>
                </div>
            </button>
            <button class="material-btn" data-material="water">
                <div class="material-swatch" style="background: #1a6bff;"></div>
                <div class="material-info">
                    <div class="material-name">Water</div>
                    <div class="material-prop">100¬∞C boiling</div>
                </div>
            </button>
            <button class="material-btn" data-material="steam">
                <div class="material-swatch" style="background: #e0e0e0;"></div>
                <div class="material-info">
                    <div class="material-name">Steam</div>
                    <div class="material-prop">Condenses</div>
                </div>
            </button>
        </div>
        
        <div class="material-grid active" data-grid="earth">
            <button class="material-btn active" data-material="sand">
                <div class="material-swatch" style="background: #c2b280;"></div>
                <div class="material-info">
                    <div class="material-name">Sand</div>
                    <div class="material-prop">1700¬∞C ‚Üí Glass</div>
                </div>
            </button>
            <button class="material-btn" data-material="glass">
                <div class="material-swatch" style="background: #88ccff; opacity: 0.6;"></div>
                <div class="material-info">
                    <div class="material-name">Glass</div>
                    <div class="material-prop">Transparent</div>
                </div>
            </button>
            <button class="material-btn" data-material="stone">
                <div class="material-swatch" style="background: #4a4a4a;"></div>
                <div class="material-info">
                    <div class="material-name">Stone</div>
                    <div class="material-prop">1200¬∞C ‚Üí Lava</div>
                </div>
            </button>
            <button class="material-btn" data-material="lava">
                <div class="material-swatch" style="background: #ff4400;"></div>
                <div class="material-info">
                    <div class="material-name">Lava</div>
                    <div class="material-prop">1200¬∞C liquid</div>
                </div>
            </button>
            <button class="material-btn" data-material="obsidian">
                <div class="material-swatch" style="background: #0f0f0f;"></div>
                <div class="material-info">
                    <div class="material-name">Obsidian</div>
                    <div class="material-prop">Cooled lava</div>
                </div>
            </button>
            <button class="material-btn" data-material="dirt">
                <div class="material-swatch" style="background: #654321;"></div>
                <div class="material-info">
                    <div class="material-name">Dirt</div>
                    <div class="material-prop">Nutrients</div>
                </div>
            </button>
            <button class="material-btn" data-material="mud">
                <div class="material-swatch" style="background: #4a3520;"></div>
                <div class="material-info">
                    <div class="material-name">Mud</div>
                    <div class="material-prop">Dirt + Water</div>
                </div>
            </button>
            <button class="material-btn" data-material="clay">
                <div class="material-swatch" style="background: #a07855;"></div>
                <div class="material-info">
                    <div class="material-name">Clay</div>
                    <div class="material-prop">Cohesive</div>
                </div>
            </button>
            <button class="material-btn" data-material="iron">
                <div class="material-swatch" style="background: #888888;"></div>
                <div class="material-info">
                    <div class="material-name">Iron</div>
                    <div class="material-prop">1538¬∞C melting</div>
                </div>
            </button>
        </div>
        
        <div class="material-grid" data-grid="energy">
            <button class="material-btn" data-material="wood">
                <div class="material-swatch" style="background: #8b4513;"></div>
                <div class="material-info">
                    <div class="material-name">Wood</div>
                    <div class="material-prop">300¬∞C ignition</div>
                </div>
            </button>
            <button class="material-btn" data-material="coal">
                <div class="material-swatch" style="background: #1a1a1a;"></div>
                <div class="material-info">
                    <div class="material-name">Coal</div>
                    <div class="material-prop">350¬∞C ignition</div>
                </div>
            </button>
            <button class="material-btn" data-material="oil">
                <div class="material-swatch" style="background: #1a1a1a;"></div>
                <div class="material-info">
                    <div class="material-name">Oil</div>
                    <div class="material-prop">210¬∞C ignition</div>
                </div>
            </button>
            <button class="material-btn" data-material="gunpowder">
                <div class="material-swatch" style="background: #2a2a2a;"></div>
                <div class="material-info">
                    <div class="material-name">Gunpowder</div>
                    <div class="material-prop">280¬∞C explosive</div>
                </div>
            </button>
            <button class="material-btn" data-material="fire">
                <div class="material-swatch" style="background: #ff4400;"></div>
                <div class="material-info">
                    <div class="material-name">Fire</div>
                    <div class="material-prop">800¬∞C plasma</div>
                </div>
            </button>
        </div>
        
        <div class="material-grid" data-grid="gases">
            <button class="material-btn" data-material="smoke">
                <div class="material-swatch" style="background: #3a3a3a;"></div>
                <div class="material-info">
                    <div class="material-name">Smoke</div>
                    <div class="material-prop">Rises</div>
                </div>
            </button>
            <button class="material-btn" data-material="oxygen">
                <div class="material-swatch" style="background: #ccffff; opacity: 0.5;"></div>
                <div class="material-info">
                    <div class="material-name">Oxygen</div>
                    <div class="material-prop">O‚ÇÇ</div>
                </div>
            </button>
            <button class="material-btn" data-material="hydrogen">
                <div class="material-swatch" style="background: #ffcccc; opacity: 0.5;"></div>
                <div class="material-info">
                    <div class="material-name">Hydrogen</div>
                    <div class="material-prop">H‚ÇÇ explosive</div>
                </div>
            </button>
            <button class="material-btn" data-material="methane">
                <div class="material-swatch" style="background: #cceecc; opacity: 0.5;"></div>
                <div class="material-info">
                    <div class="material-name">Methane</div>
                    <div class="material-prop">CH‚ÇÑ</div>
                </div>
            </button>
            <button class="material-btn" data-material="co2">
                <div class="material-swatch" style="background: #e0e0e0; opacity: 0.5;"></div>
                <div class="material-info">
                    <div class="material-name">CO‚ÇÇ</div>
                    <div class="material-prop">Sinks</div>
                </div>
            </button>
        </div>
        
        <div class="material-grid" data-grid="reactive">
            <button class="material-btn" data-material="acid">
                <div class="material-swatch" style="background: #88ff44; opacity: 0.7;"></div>
                <div class="material-info">
                    <div class="material-name">Acid</div>
                    <div class="material-prop">pH 1 corrosive</div>
                </div>
            </button>
            <button class="material-btn" data-material="salt">
                <div class="material-swatch" style="background: #f0f0f0;"></div>
                <div class="material-info">
                    <div class="material-name">Salt</div>
                    <div class="material-prop">NaCl</div>
                </div>
            </button>
            <button class="material-btn" data-material="sulfur">
                <div class="material-swatch" style="background: #ffff00;"></div>
                <div class="material-info">
                    <div class="material-name">Sulfur</div>
                    <div class="material-prop">S flammable</div>
                </div>
            </button>
        </div>
        
        <div class="material-grid" data-grid="life">
            <button class="material-btn" data-material="plant">
                <div class="material-swatch" style="background: #1a5c1a;"></div>
                <div class="material-info">
                    <div class="material-name">Plant</div>
                    <div class="material-prop">Seed 10-40¬∞C</div>
                </div>
            </button>
            <button class="material-btn" data-material="vegetation">
                <div class="material-swatch" style="background: #33aa33;"></div>
                <div class="material-info">
                    <div class="material-name">Vegetation</div>
                    <div class="material-prop">Grows/O‚ÇÇ</div>
                </div>
            </button>
            <button class="material-btn" data-material="fungus">
                <div class="material-swatch" style="background: #8b7355;"></div>
                <div class="material-info">
                    <div class="material-name">Fungus</div>
                    <div class="material-prop">Dark/damp</div>
                </div>
            </button>
            <button class="material-btn" data-material="decay">
                <div class="material-swatch" style="background: #4a3a2a;"></div>
                <div class="material-info">
                    <div class="material-name">Decay</div>
                    <div class="material-prop">‚Üí Dirt</div>
                </div>
            </button>
        </div>
        
        <!-- Brush Control -->
        <div class="control-section">
            <h3>üñåÔ∏è Brush</h3>
            <div class="control-row">
                <div class="control-item">
                    <label>Size</label>
                    <input type="range" id="brushSize" min="3" max="50" value="12">
                    <span class="value"><span id="brushSizeValue">12</span>px</span>
                </div>
            </div>
        </div>
        
        <!-- Wind Control -->
        <div class="control-section">
            <h3>üí® Wind</h3>
            <div class="control-row">
                <div class="control-item">
                    <label>X</label>
                    <input type="range" id="windX" min="-2" max="2" step="0.1" value="0">
                    <span class="value" id="windXValue">0</span>
                </div>
                <div class="control-item">
                    <label>Y</label>
                    <input type="range" id="windY" min="-2" max="2" step="0.1" value="0">
                    <span class="value" id="windYValue">0</span>
                </div>
            </div>
        </div>
        
        <!-- Volume Control (hidden until sound enabled) -->
        <div class="control-section" id="volumeSection" style="display: none;">
            <h3>üîä Volume</h3>
            <div class="control-row">
                <div class="control-item">
                    <label>Level</label>
                    <input type="range" id="volumeSlider" min="0" max="100" value="70">
                    <span class="value"><span id="volumeValue">70</span>%</span>
                </div>
            </div>
        </div>
        
        <!-- Actions -->
        <div class="control-section">
            <h3>‚öôÔ∏è Actions</h3>
            <div class="control-row">
                <button class="action-btn primary" onclick="createExplosion()">üí• Explode</button>
                <button class="action-btn" onclick="clearWorld()">üóëÔ∏è Clear All</button>
                <button class="action-btn" onclick="saveWorld()">üíæ Save World</button>
                <button class="action-btn" onclick="loadWorld()">üìÇ Load World</button>
            </div>
        </div>
        
        <!-- Scenarios -->
        <div class="control-section">
            <h3>üìã Scenarios</h3>
            <div class="scenario-grid">
                <button class="scenario-btn" onclick="loadScenario('volcano')">üåã Volcano</button>
                <button class="scenario-btn" onclick="loadScenario('lab')">üß™ Lab</button>
                <button class="scenario-btn" onclick="loadScenario('forest')">üî• Forest</button>
                <button class="scenario-btn" onclick="loadScenario('garden')">üåø Garden</button>
                <button class="scenario-btn" onclick="loadScenario('underwater')">üåä Ocean</button>
                <button class="scenario-btn" onclick="loadScenario('arctic')">‚ùÑÔ∏è Arctic</button>
            </div>
        </div>
        
        <!-- Toggles -->
        <div class="control-section">
            <h3>üëÅÔ∏è View</h3>
            <div class="toggle-row">
                <button class="action-btn toggle" id="heatBtn" onclick="toggleHeat()">üå°Ô∏è Heat</button>
                <button class="action-btn toggle" id="lightBtn" onclick="toggleLighting()">üåô Light</button>
                <button class="action-btn toggle" id="soundBtn" onclick="toggleSound()">üîä Sound</button>
                <button class="action-btn toggle" id="soundBtn" onclick="toggleSound()">üîä Sound</button>
            </div>
        </div>
        
        <!-- Debug Controls (v3.8) -->
        <div class="control-section">
            <h3>ü§ñ AI Debug</h3>
            <div class="toggle-row">
                <button class="action-btn toggle" id="debugBtn" onclick="toggleDebug()">üìä Overlay</button>
            </div>
            <div style="padding: 10px; font-size: 10px; color: #888; line-height: 1.4;">
                Debug API available in console:<br>
                ‚Ä¢ engine.test.loadScenario(name)<br>
                ‚Ä¢ engine.test.step(n)<br>
                ‚Ä¢ engine.test.snapshot()<br>
                ‚Ä¢ engine.test.getPhysicsState()<br>
                ‚Ä¢ engine.debug.enabled = true
            </div>
        </div>
        
        <!-- Status Bar -->
        <div class="status-bar">
            FPS: <span id="fps">60</span> ‚Ä¢ 
            v3.8 ‚Ä¢ 
            Materials: <span>30</span> ‚Ä¢ 
            ü§ñ <span>AI Debug API</span>
        </div>
    </div>
    
    <!-- Audio Overlay -->
    <div id="audioOverlay">
        <div class="audio-prompt">
            <div class="audio-icon">üîä</div>
            <div>Click to Enable Audio</div>
            <div class="audio-subtitle">Web Audio requires user interaction</div>
        </div>
    </div>

    <script src="bud.js"></script>
    <script>
        // Create engine (exposed globally for AI testing)
        const engine = new BudEngine({
            canvas: document.getElementById('gameCanvas'),
            width: window.innerWidth - 320,
            height: window.innerHeight,
            backgroundColor: '#0f0f1e'
        });

        // Expose engine globally for browser console access
        window.engine = engine;

        // Handle window resize
        window.addEventListener('resize', () => {
            const newWidth = window.innerWidth > 768 ? window.innerWidth - 320 : window.innerWidth;
            const newHeight = window.innerHeight;
            engine.canvas.width = newWidth;
            engine.canvas.height = newHeight;
            engine.physics.init(newWidth, newHeight, engine.physics.cellSize);
            buildInitialWorld();
        });

        // Initialize pixel physics
        engine.physics.init(engine.canvas.width, engine.canvas.height, 2);

        // Current selected material and brush size
        let selectedMaterial = 'sand';
        let brushSize = 12;
        let isMouseDown = false;
        let lastMouseX = 0;
        let lastMouseY = 0;

        // Tab switching
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                const tabName = tab.dataset.tab;
                
                // Update active tab
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                
                // Update active grid
                document.querySelectorAll('.material-grid').forEach(g => g.classList.remove('active'));
                document.querySelector(`[data-grid="${tabName}"]`).classList.add('active');
            });
        });

        // Material button selection
        document.querySelectorAll('.material-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.material-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                selectedMaterial = btn.dataset.material;
            });
        });

        // Brush size slider
        const brushSizeSlider = document.getElementById('brushSize');
        const brushSizeValue = document.getElementById('brushSizeValue');
        brushSizeSlider.addEventListener('input', (e) => {
            brushSize = parseInt(e.target.value);
            brushSizeValue.textContent = brushSize;
        });

        // Mouse interaction for placing materials
        engine.canvas.addEventListener('mousedown', (e) => {
            isMouseDown = true;
            const rect = engine.canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            lastMouseX = x;
            lastMouseY = y;
            engine.physics.circle(x, y, brushSize, selectedMaterial);
        });

        engine.canvas.addEventListener('mousemove', (e) => {
            if (!isMouseDown) return;
            
            const rect = engine.canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            // Draw line from last position to current (for smooth drawing)
            const dx = x - lastMouseX;
            const dy = y - lastMouseY;
            const dist = Math.sqrt(dx * dx + dy * dy);
            const steps = Math.ceil(dist / (brushSize / 2));
            
            for (let i = 0; i <= steps; i++) {
                const t = i / steps;
                const px = lastMouseX + dx * t;
                const py = lastMouseY + dy * t;
                engine.physics.circle(px, py, brushSize, selectedMaterial);
            }
            
            lastMouseX = x;
            lastMouseY = y;
        });

        engine.canvas.addEventListener('mouseup', () => {
            isMouseDown = false;
        });

        engine.canvas.addEventListener('mouseleave', () => {
            isMouseDown = false;
        });

        // Touch support
        engine.canvas.addEventListener('touchstart', (e) => {
            e.preventDefault();
            const touch = e.touches[0];
            const rect = engine.canvas.getBoundingClientRect();
            const x = touch.clientX - rect.left;
            const y = touch.clientY - rect.top;
            lastMouseX = x;
            lastMouseY = y;
            isMouseDown = true;
            engine.physics.circle(x, y, brushSize, selectedMaterial);
        });

        engine.canvas.addEventListener('touchmove', (e) => {
            e.preventDefault();
            if (!isMouseDown) return;
            
            const touch = e.touches[0];
            const rect = engine.canvas.getBoundingClientRect();
            const x = touch.clientX - rect.left;
            const y = touch.clientY - rect.top;
            
            const dx = x - lastMouseX;
            const dy = y - lastMouseY;
            const dist = Math.sqrt(dx * dx + dy * dy);
            const steps = Math.ceil(dist / (brushSize / 2));
            
            for (let i = 0; i <= steps; i++) {
                const t = i / steps;
                const px = lastMouseX + dx * t;
                const py = lastMouseY + dy * t;
                engine.physics.circle(px, py, brushSize, selectedMaterial);
            }
            
            lastMouseX = x;
            lastMouseY = y;
        });

        engine.canvas.addEventListener('touchend', () => {
            isMouseDown = false;
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.key === 't' || e.key === 'T') {
                toggleHeat();
            }
            if (e.key === 'l' || e.key === 'L') {
                toggleLighting();
            }
        });

        // Sound toggle
        function toggleSound() {
            const soundBtn = document.getElementById('soundBtn');
            const volumeSection = document.getElementById('volumeSection');
            const audioOverlay = document.getElementById('audioOverlay');
            
            if (!engine.physics.acoustics.enabled) {
                // Show overlay to get user interaction
                audioOverlay.classList.add('active');
                audioOverlay.onclick = () => {
                    audioOverlay.classList.remove('active');
                    const success = engine.physics.acoustics.init();
                    if (success) {
                        soundBtn.textContent = 'üîä Sound';
                        soundBtn.classList.add('active');
                        volumeSection.style.display = 'block';
                        console.log('üîä Acoustic Physics System enabled!');
                    }
                };
            } else {
                // Toggle off
                engine.physics.acoustics.enabled = false;
                soundBtn.classList.remove('active');
                volumeSection.style.display = 'none';
            }
        }
        
        // Volume slider
        const volumeSlider = document.getElementById('volumeSlider');
        const volumeValue = document.getElementById('volumeValue');
        volumeSlider.addEventListener('input', (e) => {
            const volume = parseInt(e.target.value) / 100;
            volumeValue.textContent = e.target.value;
            engine.physics.acoustics.setVolume(volume);
        });
        
        // Wind controls
        const windXSlider = document.getElementById('windX');
        const windXValue = document.getElementById('windXValue');
        const windYSlider = document.getElementById('windY');
        const windYValue = document.getElementById('windYValue');
        
        windXSlider.addEventListener('input', (e) => {
            const value = parseFloat(e.target.value);
            windXValue.textContent = value.toFixed(1);
            engine.physics.wind.x = value;
        });
        
        windYSlider.addEventListener('input', (e) => {
            const value = parseFloat(e.target.value);
            windYValue.textContent = value.toFixed(1);
            engine.physics.wind.y = value;
        });
        
        // Save/Load functions
        function saveWorld() {
            const saveData = engine.physics.save();
            if (saveData) {
                localStorage.setItem('pixelPhysics_world', JSON.stringify(saveData));
                console.log('üíæ World saved');
            }
        }
        
        function loadWorld() {
            const saveData = localStorage.getItem('pixelPhysics_world');
            if (saveData) {
                try {
                    engine.physics.load(JSON.parse(saveData));
                    console.log('üìÇ World loaded');
                    
                    // Update wind controls
                    windXSlider.value = engine.physics.wind.x;
                    windYSlider.value = engine.physics.wind.y;
                    windXValue.textContent = engine.physics.wind.x.toFixed(1);
                    windYValue.textContent = engine.physics.wind.y.toFixed(1);
                } catch (e) {
                    console.error('Failed to load world:', e);
                }
            }
        }
        
        // Heat visualization toggle
        function toggleHeat() {
            engine.physics.toggleHeatView();
            document.getElementById('heatBtn').classList.toggle('active');
        }
        
        // Lighting toggle
        function toggleLighting() {
            engine.physics.toggleLighting();
            document.getElementById('lightBtn').classList.toggle('active');
        }

        // Sound toggle (v3.8: Acoustic Physics)
        function toggleSound() {
            if (!engine.physics.acoustics.ctx) {
                // Initialize Web Audio on first click (requires user interaction)
                if (engine.physics.acoustics.init()) {
                    console.log('üîä Acoustic Physics System activated');
                    console.log('   Sound generation from real material properties');
                    console.log('   Impact, flow, reaction, and phase change sounds');
                    document.getElementById('soundBtn').classList.add('active');
                    document.getElementById('soundBtn').textContent = 'üîä Sound On';
                } else {
                    console.error('‚ùå Failed to initialize Web Audio API');
                }
            } else {
                // Toggle enabled state
                engine.physics.acoustics.enabled = !engine.physics.acoustics.enabled;
                document.getElementById('soundBtn').classList.toggle('active');
                document.getElementById('soundBtn').textContent = engine.physics.acoustics.enabled ? 'üîä Sound On' : 'üîá Sound Off';
                console.log('üîä Acoustic Physics:', engine.physics.acoustics.enabled ? 'enabled' : 'disabled');
            }
        }

        // Debug toggle (v3.8)
        function toggleDebug() {
            engine.debugSystem.enabled = !engine.debugSystem.enabled;
            document.getElementById('debugBtn').classList.toggle('active');
            console.log('ü§ñ Debug overlay:', engine.debugSystem.enabled ? 'enabled' : 'disabled');
        }

        // Explosion function
        function createExplosion() {
            const x = engine.canvas.width / 2 + (Math.random() - 0.5) * 200;
            const y = engine.canvas.height / 2 + (Math.random() - 0.5) * 200;
            engine.physics.explode(x, y, 70, 200);
            engine.cameraShake(10);
        }

        // Clear world function
        function clearWorld() {
            engine.physics.clearArea(0, 0, engine.canvas.width, engine.canvas.height);
        }

        // Load scenario
        function loadScenario(name) {
            clearWorld();
            
            const w = engine.canvas.width;
            const h = engine.canvas.height;
            
            if (name === 'volcano') {
                // Stone ground
                engine.physics.fill(0, h*0.92, w, h, 'stone');
                // Volcano mountain shape
                engine.physics.fill(w*0.15, h*0.7, w*0.85, h*0.92, 'stone');
                engine.physics.fill(w*0.25, h*0.55, w*0.75, h*0.7, 'stone');
                engine.physics.fill(w*0.35, h*0.45, w*0.65, h*0.55, 'stone');
                // Lava chamber inside (carve out)
                engine.physics.fill(w*0.35, h*0.55, w*0.65, h*0.85, 'lava');
                // Chimney opening at top
                engine.physics.fill(w*0.42, h*0.45, w*0.58, h*0.55, 'lava');
                // Water pool nearby
                engine.physics.fill(w*0.02, h*0.85, w*0.12, h*0.92, 'water');
                
                console.log('üåã Volcano scenario loaded');
            } else if (name === 'lab') {
                // Stone floor
                engine.physics.fill(0, h*0.92, w, h, 'stone');
                // Test tubes (glass containers with materials)
                const tubes = [
                    {x: 0.12, mat: 'acid', label: 'Acid'},
                    {x: 0.27, mat: 'water', label: 'Water'},
                    {x: 0.42, mat: 'oil', label: 'Oil'},
                    {x: 0.57, mat: 'lava', label: 'Lava'},
                    {x: 0.72, mat: 'salt', label: 'Salt'}
                ];
                tubes.forEach(t => {
                    const tx = w*t.x;
                    const tw = w*0.06;
                    // Glass walls
                    engine.physics.fill(tx, h*0.6, tx+4, h*0.92, 'glass');
                    engine.physics.fill(tx+tw, h*0.6, tx+tw+4, h*0.92, 'glass');
                    // Glass bottom
                    engine.physics.fill(tx, h*0.88, tx+tw, h*0.92, 'glass');
                    // Material inside
                    engine.physics.fill(tx+4, h*0.7, tx+tw, h*0.88, t.mat);
                });
                // Metal sample
                engine.physics.fill(w*0.87, h*0.85, w*0.93, h*0.92, 'iron');
                // Gunpowder pile
                engine.physics.circle(w*0.05, h*0.88, 15, 'gunpowder');
                
                console.log('üß™ Lab scenario loaded');
            } else if (name === 'forest') {
                // Trees (wood) - spaced across width
                const treeCount = Math.min(8, Math.floor(w / 100));
                for (let i = 0; i < treeCount; i++) {
                    const x = (w * 0.1) + (i * (w * 0.8 / treeCount));
                    engine.physics.fill(x, h*0.55, x + (w*0.05), h*0.9, 'wood');
                }
                // Ground
                engine.physics.fill(0, h*0.9, w, h, 'dirt');
                // Some vegetation
                for (let i = 0; i < 10; i++) {
                    const x = Math.random() * w;
                    engine.physics.circle(x, h*0.88, 10, 'vegetation');
                }
                // Starting fire
                engine.physics.circle(w*0.15, h*0.6, 15, 'fire');
                
                console.log('üî• Forest fire scenario loaded');
            } else if (name === 'garden') {
                // Thick soil base (bottom 30%)
                engine.physics.fill(0, h*0.7, w, h, 'dirt');
                
                // Water pools (two channels)
                engine.physics.fill(w*0.25, h*0.65, w*0.28, h, 'water');
                engine.physics.fill(w*0.72, h*0.65, w*0.75, h, 'water');
                
                // Stone overhangs for fungus
                engine.physics.fill(w*0.05, h*0.6, w*0.15, h*0.7, 'stone');
                engine.physics.fill(w*0.85, h*0.55, w*0.95, h*0.68, 'stone');
                
                // Pre-warm the soil to perfect growing temperature (25¬∞C)
                const cs = engine.physics.cellSize;
                for (let gx = 0; gx < engine.physics.gridWidth; gx++) {
                    for (let gy = Math.floor((h*0.7)/cs); gy < engine.physics.gridHeight; gy++) {
                        const idx = engine.physics.index(gx, gy);
                        if (engine.physics.grid[idx] === engine.physics.getMaterialId('dirt')) {
                            engine.physics.temperatureGrid[idx] = 25;
                        }
                    }
                }
                
                // Plant seeds scattered across soil
                for (let i = 0; i < 20; i++) {
                    const x = Math.random() * w;
                    const y = h*0.68 + Math.random() * (h*0.08);
                    engine.physics.circle(x, y, 3, 'plant');
                }
                
                // Some initial vegetation clusters
                for (let i = 0; i < 12; i++) {
                    const x = Math.random() * w;
                    const y = h*0.68 + Math.random() * (h*0.08);
                    engine.physics.circle(x, y, 8, 'vegetation');
                }
                
                // Add fungus under the stone overhangs (dark areas)
                for (let i = 0; i < 8; i++) {
                    const x = w*0.05 + Math.random() * (w*0.1);
                    const y = h*0.65 + Math.random() * (h*0.05);
                    engine.physics.circle(x, y, 5, 'fungus');
                }
                for (let i = 0; i < 8; i++) {
                    const x = w*0.85 + Math.random() * (w*0.1);
                    const y = h*0.63 + Math.random() * (h*0.05);
                    engine.physics.circle(x, y, 5, 'fungus');
                }
                
                console.log('üåø Garden scenario loaded - Watch life grow!');
            } else if (name === 'underwater') {
                // Water (upper 85%)
                engine.physics.fill(0, h*0.15, w, h, 'water');
                // Sand bottom (lower 8%)
                engine.physics.fill(0, h*0.92, w, h, 'sand');
                // Underwater volcano
                engine.physics.fill(w*0.4, h*0.83, w*0.6, h*0.92, 'stone');
                engine.physics.circle(w*0.5, h*0.87, w*0.04, 'lava');
                
                console.log('üåä Underwater scenario loaded');
            } else if (name === 'arctic') {
                // Ice shelf (thick middle layer)
                engine.physics.fill(0, h*0.4, w, h*0.6, 'ice');
                // Water below
                engine.physics.fill(0, h*0.6, w, h, 'water');
                // Some lava to melt it
                engine.physics.circle(w*0.5, h*0.5, w*0.05, 'lava');
                
                console.log('‚ùÑÔ∏è Arctic scenario loaded');
            }
        }

        // Build initial world
        function buildInitialWorld() {
            const w = engine.canvas.width;
            const h = engine.canvas.height;
            
            // Bottom stone floor (5% height at bottom)
            engine.physics.fill(0, h - h*0.05, w, h, 'stone');
            
            // Stone walls on sides (3% of width)
            const wallW = Math.max(25, w*0.03);
            engine.physics.fill(0, 0, wallW, h, 'stone');
            engine.physics.fill(w - wallW, 0, w, h, 'stone');
            
            // Wooden platforms (proportional to canvas size)
            engine.physics.fill(w*0.1, h*0.85, w*0.35, h*0.87, 'wood');
            engine.physics.fill(w*0.55, h*0.75, w*0.8, h*0.77, 'wood');
            
            // Some dirt patches
            engine.physics.fill(w*0.35, h*0.9, w*0.55, h*0.94, 'dirt');
            
            // Plant a seed
            engine.physics.circle(w*0.45, h*0.88, 5, 'plant');
            
            // Add some initial vegetation
            engine.physics.circle(w*0.5, h*0.88, 8, 'vegetation');
        }

        // Initialize world
        buildInitialWorld();

        // Main scene
        engine.scene('main', {
            enter() {
                console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
                console.log('‚öõÔ∏è PIXEL PHYSICS v3.8 - ACOUSTIC PHYSICS SYSTEM');
                console.log('üîä Sound generation from real material properties');
                console.log('   Click "üîä Sound" button to enable audio');
                console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
                console.log('NEW IN v3.8:');
                console.log('  ü§ñ Comprehensive testing API for AI developers');
                console.log('  üìä Debug overlay: FPS, materials, chunks, frame counter');
                console.log('  üß™ Scenario loading: engine.test.loadScenario(name)');
                console.log('  ‚è≠Ô∏è  Simulation stepping: engine.test.step(n)');
                console.log('  üì∏ Canvas snapshots: engine.test.snapshot()');
                console.log('  üìà State inspection: engine.test.getPhysicsState()');
                console.log('  üîç Material queries: engine.test.getMaterialAt(x, y)');
                console.log('  üé® Material placement: engine.test.placeMaterial(x, y, mat)');
                console.log('  üóëÔ∏è World clearing: engine.test.clearWorld()');
                console.log('  üé® Pixel reading: engine.test.getPixelColor(x, y)');
                console.log('  üìù Logging system: engine.debug.log(msg)');
                console.log('  üëÄ Property watching: engine.debug.watch(property)');
                console.log('');
                console.log('ü§ñ AI DEVELOPER WORKFLOW:');
                console.log('  1. Load scenario: engine.test.loadScenario("garden")');
                console.log('  2. Enable debug: engine.debug.enabled = true');
                console.log('  3. Run simulation: engine.test.step(100)');
                console.log('  4. Check state: engine.test.getPhysicsState()');
                console.log('  5. Take snapshot: engine.test.snapshot()');
                console.log('  6. Inspect materials: engine.test.getMaterialAt(x, y)');
                console.log('');
                console.log('üî¨ Materials: ~30 total (including 5 living materials)');
                console.log('T = heat view ‚Ä¢ L = lighting ‚Ä¢ Use sidebar to select materials');
                console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
            },
            
            update(dt) {
                // Update FPS display
                document.getElementById('fps').textContent = engine.fps;
            }
        });

        // Start engine
        engine.goTo('main');
        engine.start();
    </script>
</body>
</html>
