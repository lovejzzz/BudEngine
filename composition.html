<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#000000">
    <title>The Composition - Your Instrument is the Earth</title>
    
    <!-- PWA manifest -->
    <link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiVGhlIENvbXBvc2l0aW9uIiwic2hvcnRfbmFtZSI6IkNvbXBvc2l0aW9uIiwic3RhcnRfdXJsIjoiLiIsImRpc3BsYXkiOiJzdGFuZGFsb25lIiwiYmFja2dyb3VuZF9jb2xvciI6IiMwMDAwMDAiLCJ0aGVtZV9jb2xvciI6IiMwMDAwMDAifQ==">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
            -webkit-user-select: none;
        }

        body, html {
            width: 100%;
            height: 100%;
            overflow: hidden;
            background: #000;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            color: #fff;
            position: fixed;
            touch-action: none;
            overscroll-behavior: none;
        }

        #game-container {
            position: relative;
            width: 100%;
            height: 100%;
        }

        canvas {
            display: block;
            width: 100%;
            height: 100%;
            touch-action: none;
        }

        /* Welcome Overlay (first visit only) */
        #welcome-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.95);
            backdrop-filter: blur(10px);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            pointer-events: all;
            opacity: 1;
            transition: opacity 0.5s ease;
        }

        #welcome-overlay.fade-out {
            opacity: 0;
            pointer-events: none;
        }

        #welcome-title {
            font-size: 32px;
            font-weight: 300;
            letter-spacing: 4px;
            text-transform: uppercase;
            color: #fff;
            margin-bottom: 20px;
            text-shadow: 0 0 30px rgba(255,255,255,0.5);
        }

        #welcome-subtitle {
            font-size: 16px;
            font-weight: 300;
            letter-spacing: 2px;
            color: rgba(255,255,255,0.8);
            margin-bottom: 60px;
        }

        #welcome-tap {
            font-size: 16px;
            color: rgba(255,255,255,0.6);
            letter-spacing: 1px;
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 0.4; }
            50% { opacity: 1; }
        }

        /* Version stamp */
        #version-stamp {
            position: fixed;
            bottom: 5px;
            right: 10px;
            color: rgba(255,255,255,0.5);
            font: 10px monospace;
            z-index: 9999;
            pointer-events: none;
        }

        /* Responsive adjustments */
        @media (max-width: 600px) {
            #welcome-title {
                font-size: 28px;
                letter-spacing: 3px;
            }

            #welcome-subtitle {
                font-size: 14px;
            }
        }
    </style>
</head>
<body>
    <div id="game-container">
        <canvas id="gameCanvas"></canvas>
        
        <!-- Welcome Overlay (first visit only) -->
        <div id="welcome-overlay" style="display: none;">
            <div id="welcome-title">THE COMPOSITION</div>
            <div id="welcome-subtitle">Your instrument is the Earth</div>
            <div id="welcome-tap">[Tap to Begin]</div>
        </div>
    </div>

    <script src="bud.js?v=57"></script>
    <script>
        // The Composition v4.4
        // Your instrument is the Earth
        // v4.4: Pixel-art UI — everything rendered as pixel art on canvas

        // Initialize engine
        const canvas = document.getElementById('gameCanvas');
        
        // Force canvas pixel size to match CSS display size (critical for mobile touch)
        function syncCanvasSize() {
            const w = canvas.clientWidth || window.innerWidth;
            const h = canvas.clientHeight || window.innerHeight;
            canvas.width = w;
            canvas.height = h;
            return { w, h };
        }
        
        const initSize = syncCanvasSize();
        const engine = new BudEngine({
            canvas: canvas,
            width: initSize.w,
            height: initSize.h,
            backgroundColor: '#0a0a14'
        });
        
        // Re-sync after engine constructor (it may override canvas.width/height)
        canvas.width = initSize.w;
        canvas.height = initSize.h;

        // Initialize physics
        engine.physics.init(initSize.w, initSize.h, 3);

        // Initialize composition game
        engine.composition = new CompositionGame(engine);

        // v4.4: Initialize PixelUI (replaces ALL HTML UI)
        const pixelUI = new PixelUI(engine);

        // Touch/mouse input state
        let isDrawing = false;
        let lastDrawX = null;
        let lastDrawY = null;

        function getInputPos(e) {
            const rect = canvas.getBoundingClientRect();
            const touch = e.touches && e.touches[0] ? e.touches[0] : 
                          e.changedTouches && e.changedTouches[0] ? e.changedTouches[0] : e;
            // Use clientX/Y relative to canvas rect, scaled by pixel ratio
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;
            const x = (touch.clientX - rect.left) * scaleX;
            const y = (touch.clientY - rect.top) * scaleY;
            return { x, y };
        }

        function startDrawing(e) {
            e.preventDefault();
            const pos = getInputPos(e);
            isDrawing = true;
            lastDrawX = pos.x;
            lastDrawY = pos.y;

            // v4.4: Route through PixelUI first
            if (pixelUI.handleTouch(pos.x, pos.y, true)) {
                isDrawing = false; // UI consumed the input
                return;
            }

            // Gesture tracking for composition game
            engine.composition.onGestureStart(pos.x, pos.y);

            // Place material
            if (engine.composition.mode === 'creation') {
                placeMaterial(pos.x, pos.y);
            }
        }

        function continueDrawing(e) {
            if (!isDrawing) return;
            e.preventDefault();
            const pos = getInputPos(e);

            // Gesture tracking
            engine.composition.onGestureMove(pos.x, pos.y);

            // Continue placing material
            if (engine.composition.mode === 'creation') {
                // Interpolate between last pos and current for smooth drawing
                const dx = pos.x - lastDrawX;
                const dy = pos.y - lastDrawY;
                const dist = Math.sqrt(dx * dx + dy * dy);
                const steps = Math.max(1, Math.floor(dist / 5));

                for (let i = 0; i < steps; i++) {
                    const t = i / steps;
                    const x = lastDrawX + dx * t;
                    const y = lastDrawY + dy * t;
                    placeMaterial(x, y);
                }
            }

            lastDrawX = pos.x;
            lastDrawY = pos.y;
        }

        function stopDrawing(e) {
            if (!isDrawing) return;
            e.preventDefault();
            const pos = getInputPos(e);
            isDrawing = false;

            // Gesture tracking
            engine.composition.onGestureEnd(pos.x, pos.y);
        }

        function placeMaterial(x, y) {
            // physics.circle() takes PIXEL coordinates
            const radius = 8;
            const selectedMaterial = pixelUI.getSelectedMaterial();
            engine.physics.circle(x, y, radius, selectedMaterial);
        }

        // Touch events
        canvas.addEventListener('touchstart', startDrawing, { passive: false });
        canvas.addEventListener('touchmove', continueDrawing, { passive: false });
        canvas.addEventListener('touchend', stopDrawing, { passive: false });

        // Mouse events
        canvas.addEventListener('mousedown', startDrawing);
        canvas.addEventListener('mousemove', continueDrawing);
        canvas.addEventListener('mouseup', stopDrawing);
        canvas.addEventListener('mouseleave', stopDrawing);

        // Game scene
        engine.scene('main', {
            init() {
                console.log('[The Composition v4.4] Pixel-art UI enabled');
            },

            update(dt) {
                // Update physics
                engine.physics.update(dt);

                // Update composition game
                engine.composition.update(dt);
            },

            render() {
                // Render physics
                engine.physics.render();

                // v4.4: Render PixelUI on top of everything
                const ctx = canvas.getContext('2d');
                pixelUI.render(ctx);
            }
        });

        // Start game
        engine.goTo('main');
        engine.start();

        // Auto-garden on EVERY page load (not just first visit)
        setTimeout(() => {
            engine.test.clearWorld();
            engine.test.loadScenario('garden');
            pixelUI.mode = 'creation'; // Reset to creation mode after garden loads
        }, 1500);

        // First visit: show welcome overlay
        if (!localStorage.getItem('composition_visited')) {
            const welcomeOverlay = document.getElementById('welcome-overlay');
            welcomeOverlay.style.display = 'flex';

            welcomeOverlay.onclick = () => {
                // Dismiss overlay
                welcomeOverlay.classList.add('fade-out');
                setTimeout(() => {
                    welcomeOverlay.style.display = 'none';
                }, 500);

                // Mark as visited
                localStorage.setItem('composition_visited', '1');

                // Auto-enable sound on welcome tap
                engine.physics.acoustics.init();

                // Initialize audio on tap (iOS requirement)
                if (engine.physics.acoustics.ctx && engine.physics.acoustics.ctx.state === 'suspended') {
                    engine.physics.acoustics.ctx.resume();
                }
            };
        }

        // Handle window resize
        window.addEventListener('resize', () => {
            const size = syncCanvasSize();
            const width = size.w;
            const height = size.h;
            engine.config.width = width;
            engine.config.height = height;

            // Reinitialize physics with new dimensions
            const oldGrid = engine.physics.grid ? new Uint8Array(engine.physics.grid) : null;
            const oldWidth = engine.physics.gridWidth;
            const oldHeight = engine.physics.gridHeight;
            
            engine.physics.init(width, height, 3);

            // Copy old grid if it exists
            if (oldGrid) {
                const minWidth = Math.min(oldWidth, engine.physics.gridWidth);
                const minHeight = Math.min(oldHeight, engine.physics.gridHeight);
                for (let y = 0; y < minHeight; y++) {
                    for (let x = 0; x < minWidth; x++) {
                        const oldIdx = y * oldWidth + x;
                        const newIdx = y * engine.physics.gridWidth + x;
                        engine.physics.grid[newIdx] = oldGrid[oldIdx];
                    }
                }
            }
        });

        // Prevent context menu on long press
        window.addEventListener('contextmenu', e => e.preventDefault());

        // Prevent iOS Safari bounce/scroll on the whole document
        document.addEventListener('touchmove', e => {
            e.preventDefault();
        }, { passive: false });

        // Resume audio context on any interaction (iOS requirement)
        document.addEventListener('touchstart', () => {
            if (engine.physics.acoustics.ctx && engine.physics.acoustics.ctx.state === 'suspended') {
                engine.physics.acoustics.ctx.resume();
            }
        }, { once: true });

        console.log('[The Composition v4.4] Pixel-art UI — all buttons, palette, HUD rendered as pixel art on canvas');
    </script>
    <div id="version-stamp">v4.4</div>
</body>
</html>
